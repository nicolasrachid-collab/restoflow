generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  OPERATOR
}

enum QueueStatus {
  WAITING
  NOTIFIED
  CALLED
  NO_SHOW
  CANCELLED
  DONE
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CANCELLED
  NO_SHOW
  COMPLETED
}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  name              String
  passwordHash      String      @map("password_hash")
  role              UserRole    @default(OPERATOR)
  isActive          Boolean     @default(true) @map("is_active")
  mustChangePassword Boolean    @default(false) @map("must_change_password")
  lastLoginAt       DateTime?   @map("last_login_at")
  restaurantId      String?     @map("restaurant_id")
  restaurant        Restaurant? @relation(fields: [restaurantId], references: [id])
  auditLogs         AuditLog[]
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@map("users")
}

model Restaurant {
  id                      String          @id @default(uuid())
  name                    String
  slug                    String          @unique
  address                 String
  isActive                Boolean         @default(true) @map("is_active")
  queueActive             Boolean         @default(true) @map("queue_active")
  maxPartySize            Int             @default(20) @map("max_party_size")
  averageTableTimeMinutes Int             @default(45) @map("average_table_time_minutes")
  calledTimeoutMinutes    Int             @default(10) @map("called_timeout_minutes")
  minReservationAdvanceHours Int         @default(2) @map("min_reservation_advance_hours")
  maxReservationAdvanceDays  Int          @default(30) @map("max_reservation_advance_days")
  users                   User[]
  menuItems               MenuItem[]
  queueItems              QueueItem[]
  reservations            Reservation[]
  publicLinks             PublicLink[]
  operatingHours          OperatingHours[]
  categories              Category[]
  auditLogs               AuditLog[]
  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")

  @@map("restaurants")
}

model Category {
  id           String     @id @default(uuid())
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  name         String
  isActive     Boolean    @default(true) @map("is_active")
  displayOrder Int        @default(0) @map("display_order")
  menuItems    MenuItem[]
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@map("categories")
}

model MenuItem {
  id            String           @id @default(uuid())
  name          String
  description   String?
  price         Float
  category      String?          // Mantido para compatibilidade
  categoryId    String?           @map("category_id")
  categoryRef   Category?        @relation(fields: [categoryId], references: [id])
  imageUrl      String?          @map("image_url")
  isActive      Boolean          @default(true) @map("is_active")
  available     Boolean          @default(true)
  restaurantId  String           @map("restaurant_id")
  restaurant    Restaurant       @relation(fields: [restaurantId], references: [id])
  variants      MenuItemVariant[]
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  @@map("menu_items")
}

model MenuItemVariant {
  id            String   @id @default(uuid())
  menuItemId    String   @map("menu_item_id")
  menuItem      MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  name          String
  isRequired    Boolean  @default(false) @map("is_required")
  priceModifier Float    @default(0) @map("price_modifier")
  displayOrder Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("menu_item_variants")
}

model Customer {
  id           String       @id @default(uuid())
  name         String
  phone        String       @unique
  email        String?
  queueItems   QueueItem[]
  reservations Reservation[]
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@map("customers")
}

model PublicLink {
  id           String     @id @default(uuid())
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  code         String     @unique
  name         String?
  slug         String
  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@map("public_links")
}

model OperatingHours {
  id           String     @id @default(uuid())
  restaurantId String     @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  dayOfWeek    Int        @map("day_of_week") // 0=domingo, 6=s√°bado
  isOpen       Boolean    @default(true) @map("is_open")
  openTime     String     @map("open_time") // Formato "HH:mm"
  closeTime    String     @map("close_time") // Formato "HH:mm"
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@unique([restaurantId, dayOfWeek])
  @@map("operating_hours")
}

model AuditLog {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  userId       String?  @map("user_id")
  user         User?    @relation(fields: [userId], references: [id])
  entityType   String   @map("entity_type") // "QueueItem", "Reservation", "User", etc
  entityId     String   @map("entity_id")
  action       String   // "CREATE", "UPDATE", "DELETE", "STATUS_CHANGE"
  oldValue     Json?    @map("old_value")
  newValue     Json?    @map("new_value")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([restaurantId, entityType, entityId])
  @@index([restaurantId, createdAt])
  @@map("audit_logs")
}

model QueueItem {
  id           String      @id @default(uuid())
  customerName String      @map("customer_name")
  phone        String
  email        String?
  partySize    Int         @map("party_size")
  status       QueueStatus @default(WAITING)
  restaurantId String      @map("restaurant_id")
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])
  customerId   String?     @map("customer_id")
  customer     Customer?   @relation(fields: [customerId], references: [id])
  notifiedAt   DateTime?   @map("notified_at")
  calledAt     DateTime?   @map("called_at")
  noShowAt      DateTime?   @map("no_show_at")
  position      Int         @default(0)
  manualOrder   Boolean     @default(false) @map("manual_order")
  joinedAt      DateTime    @default(now()) @map("joined_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@map("queue_items")
}

model Reservation {
  id                   String            @id @default(uuid())
  customerName         String            @map("customer_name")
  phone                String
  email                String?
  partySize            Int               @map("party_size")
  date                 DateTime
  status               ReservationStatus @default(PENDING)
  restaurantId         String            @map("restaurant_id")
  restaurant           Restaurant        @relation(fields: [restaurantId], references: [id])
  customerId           String?           @map("customer_id")
  customer             Customer?         @relation(fields: [customerId], references: [id])
  checkedInAt          DateTime?         @map("checked_in_at")
  noShowAt             DateTime?         @map("no_show_at")
  originalReservationId String?          @map("original_reservation_id")
  notes                String?
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")

  @@map("reservations")
}
